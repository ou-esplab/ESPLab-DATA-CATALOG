<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ESPLab Data Catalog</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; }
  .tabs { display: flex; cursor: pointer; margin-bottom: 1em; }
  .tab { padding: 10px 20px; border: 1px solid #ccc; border-bottom: none; background: #eee; }
  .tab.active { background: white; font-weight: bold; }
  .tab-content { border: 1px solid #ccc; padding: 20px; }
  label { display: block; margin: 10px 0 5px; }
  select { width: 250px; padding: 5px; }
  .dataset {
    border: 1px solid #ddd;
    padding: 10px;
    margin: 10px 0;
    background: #f9f9f9;
  }
  .dataset strong { font-size: 1.1em; }
  .metadata {
    margin-top: 5px;
    font-size: 0.9em;
    color: #555;
  }
</style>
</head>
<body>

<h1>ESPLab Data Catalog</h1>

<div class="tabs">
  <div class="tab active" data-tab="obs">Observations</div>
  <div class="tab" data-tab="reanalysis">Reanalysis</div>
</div>

<div id="obs" class="tab-content">
  <label for="obs-domain">Domain:</label>
  <select id="obs-domain"><option value="">-- Select Domain --</option></select>

  <label for="obs-dataset">Dataset:</label>
  <select id="obs-dataset" disabled><option value="">-- Select Dataset --</option></select>

  <label for="obs-temporal">Temporal Resolution:</label>
  <select id="obs-temporal" disabled><option value="">-- Select Temporal Resolution --</option></select>

  <label for="obs-variable">Variable:</label>
  <select id="obs-variable" disabled><option value="">-- Select Variable --</option></select>

  <div id="obs-datasets-list"></div>
</div>

<div id="reanalysis" class="tab-content" style="display:none;">
  <label for="rean-dataset">Dataset:</label>
  <select id="rean-dataset"><option value="">-- Select Dataset --</option></select>

  <label for="rean-temporal">Temporal Resolution:</label>
  <select id="rean-temporal" disabled><option value="">-- Select Temporal Resolution --</option></select>

  <label for="rean-variable">Variable:</label>
  <select id="rean-variable" disabled><option value="">-- Select Variable --</option></select>

  <div id="rean-datasets-list"></div>
</div>

<script>
  // Tab switching
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      document.querySelectorAll('.tab-content').forEach(c => c.style.display = 'none');
      document.getElementById(tab.dataset.tab).style.display = 'block';
    });
  });

  // Utility: clear select options except first placeholder
  function clearSelect(select) {
    while (select.options.length > 1) select.remove(1);
    select.disabled = true;
  }

  // Utility: populate select with sorted unique values
  function populateSelect(select, values) {
    values.sort().forEach(v => {
      const opt = document.createElement('option');
      opt.value = v;
      opt.textContent = v;
      select.appendChild(opt);
    });
    select.disabled = false;
  }

  // Utility: display datasets list with metadata
  function displayDatasets(container, datasets) {
    container.innerHTML = '';
    if (datasets.length === 0) {
      container.textContent = 'No datasets found.';
      return;
    }
    datasets.forEach(ds => {
      const div = document.createElement('div');
      div.className = 'dataset';
      div.innerHTML = `
        <strong>${ds.dataset}</strong><br/>
        <div class="metadata">
          Description: ${ds.description || 'N/A'}<br/>
          Date Range: ${ds.date_range || 'N/A'}<br/>
          Units: ${ds.units || 'N/A'}<br/>
          Files: ${ds.n_files || 'N/A'}<br/>
          Data Location: ${ds.data_location || 'N/A'}
        </div>
      `;
      container.appendChild(div);
    });
  }

  // Fetch JSON data
  async function fetchJSON(url) {
    try {
      const resp = await fetch(url);
      if (!resp.ok) throw new Error(`Failed to load ${url}`);
      return await resp.json();
    } catch(e) {
      console.error(e);
      return null;
    }
  }

  // OBS logic
  (async function(){
    const data = await fetchJSON('obs.json');
    if (!data) return;

    // The obs catalog keys are like:
    // "obs/gridded/<domain>/<variable>/<temporal>/<dataset>"

    // We'll parse all keys to build dropdown options grouped by domain, dataset, temporal, variable

    // Extract sources array with parsed metadata for easier processing
    const sources = Object.entries(data.sources).map(([key, val]) => {
      const parts = key.split('/');
      return {
        key,
        domain: parts[2] || '',
        variable: parts[3] || '',
        temporal: parts[4] || '',
        dataset: parts[5] || '',
        description: val.description,
        date_range: val.metadata?.date_range,
        units: val.metadata?.units,
        n_files: val.metadata?.n_files,
        data_location: val.metadata?.data_location
      };
    });

    // Populate Domain dropdown
    const domainSelect = document.getElementById('obs-domain');
    const datasetSelect = document.getElementById('obs-dataset');
    const temporalSelect = document.getElementById('obs-temporal');
    const variableSelect = document.getElementById('obs-variable');
    const datasetsList = document.getElementById('obs-datasets-list');

    const domains = [...new Set(sources.map(s => s.domain))];
    populateSelect(domainSelect, domains);

    domainSelect.addEventListener('change', () => {
      clearSelect(datasetSelect);
      clearSelect(temporalSelect);
      clearSelect(variableSelect);
      datasetsList.innerHTML = '';

      if (!domainSelect.value) return;

      const filteredByDomain = sources.filter(s => s.domain === domainSelect.value);
      const datasets = [...new Set(filteredByDomain.map(s => s.dataset))];
      populateSelect(datasetSelect, datasets);
    });

    datasetSelect.addEventListener('change', () => {
      clearSelect(temporalSelect);
      clearSelect(variableSelect);
      datasetsList.innerHTML = '';

      if (!datasetSelect.value) return;

      const filteredByDataset = sources.filter(s => 
        s.domain === domainSelect.value && s.dataset === datasetSelect.value
      );
      const temporals = [...new Set(filteredByDataset.map(s => s.temporal))];
      populateSelect(temporalSelect, temporals);
    });

    temporalSelect.addEventListener('change', () => {
      clearSelect(variableSelect);
      datasetsList.innerHTML = '';

      if (!temporalSelect.value) return;

      const filteredByTemporal = sources.filter(s =>
        s.domain === domainSelect.value &&
        s.dataset === datasetSelect.value &&
        s.temporal === temporalSelect.value
      );
      const variables = [...new Set(filteredByTemporal.map(s => s.variable))];
      populateSelect(variableSelect, variables);
    });

    variableSelect.addEventListener('change', () => {
      datasetsList.innerHTML = '';
      if (!variableSelect.value) return;

      const filteredByVariable = sources.filter(s =>
        s.domain === domainSelect.value &&
        s.dataset === datasetSelect.value &&
        s.temporal === temporalSelect.value &&
        s.variable === variableSelect.value
      );
      displayDatasets(datasetsList, filteredByVariable);
    });
  })();

  // REANALYSIS logic
  (async function(){
    const data = await fetchJSON('reanalysis.json');
    if (!data) return;

    // reanalysis keys are like:
    // "reanalysis/<dataset>/<temporal>/<variable>"

    const sources = Object.entries(data.sources).map(([key, val]) => {
      const parts = key.split('/');
      return {
        key,
        dataset: parts[1] || '',
        temporal: parts[2] || '',
        variable: parts[3] || '',
        description: val.description,
        date_range: val.metadata?.date_range,
        units: val.metadata?.units,
        n_files: val.metadata?.n_files,
        data_location: val.metadata?.data_location
      };
    });

    const datasetSelect = document.getElementById('rean-dataset');
    const temporalSelect = document.getElementById('rean-temporal');
    const variableSelect = document.getElementById('rean-variable');
    const datasetsList = document.getElementById('rean-datasets-list');

    const datasets = [...new Set(sources.map(s => s.dataset))];
    populateSelect(datasetSelect, datasets);

    datasetSelect.addEventListener('change', () => {
      clearSelect(temporalSelect);
      clearSelect(variableSelect);
      datasetsList.innerHTML = '';

      if (!datasetSelect.value) return;

      const filteredByDataset = sources.filter(s => s.dataset === datasetSelect.value);
      const temporals = [...new Set(filteredByDataset.map(s => s.temporal))];
      populateSelect(temporalSelect, temporals);
    });

    temporalSelect.addEventListener('change', () => {
      clearSelect(variableSelect);
      datasetsList.innerHTML = '';

      if (!temporalSelect.value) return;

      const filteredByTemporal = sources.filter(s =>
        s.dataset === datasetSelect.value &&
        s.temporal === temporalSelect.value
      );
      const variables = [...new Set(filteredByTemporal.map(s => s.variable))];
      populateSelect(variableSelect, variables);
    });

    variableSelect.addEventListener('change', () => {
      datasetsList.innerHTML = '';
      if (!variableSelect.value) return;

      const filteredByVariable = sources.filter(s =>
        s.dataset === datasetSelect.value &&
        s.temporal === temporalSelect.value &&
        s.variable === variableSelect.value
      );
      displayDatasets(datasetsList, filteredByVariable);
    });
  })();
</script>

</body>
</html>

